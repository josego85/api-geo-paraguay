name: Build

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: '22'
      retention-days:
        required: false
        type: number
        default: 7

jobs:
  build:
    name: Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443
            nodejs.org:443
            registry.npmjs.org:443
            objects.githubusercontent.com:443

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ inputs.node-version }}

      - name: Build
        run: |
          npm run build
          du -sh dist/
          test -f dist/bundle.js || exit 1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: dist/
          retention-days: ${{ inputs.retention-days }}
